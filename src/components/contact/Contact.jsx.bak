import React, { useReducer, useCallback, useRef, useEffect } from "react";
import { motion } from "framer-motion";
import { PageHeader } from "../";

// ============================================================================
// CONSTANTS
// ============================================================================

const SOCIAL_LINKS = [
  {
    href: "https://www.linkedin.com/in/riad-kilani",
    className: "linkedin",
    icon: "fab fa-linkedin",
    label: "Connect with Riad Kilani on LinkedIn",
    name: "LinkedIn"
  },
  {
    href: "https://github.com/SyntaxSidekick",
    className: "github",
    icon: "fab fa-github",
    label: "View Riad Kilani's code on GitHub",
    name: "GitHub"
  },
  {
    href: "https://codepen.io/SyntaxSidekick",
    className: "codepen",
    icon: "fab fa-codepen",
    label: "See Riad Kilani's experiments on CodePen",
    name: "CodePen"
  },
  {
    href: "https://x.com/syntaxsidekick",
    className: "twitter",
    icon: "fab fa-x-twitter",
    label: "Follow Riad Kilani on X (formerly Twitter)",
    name: "X (Twitter)"
  }
];

const FORM_FIELDS = [
  { 
    name: "name", 
    type: "text", 
    label: "Name", 
    autoComplete: "name",
    helpText: "Enter your full name",
    minLength: 2
  },
  { 
    name: "email", 
    type: "email", 
    label: "Email", 
    autoComplete: "email",
    helpText: "Enter a valid email address"
  },
  { 
    name: "message", 
    type: "textarea", 
    label: "Message",
    helpText: "Enter your message, minimum 10 characters",
    minLength: 10,
    rows: 5
  }
];

const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

// ============================================================================
// COMPONENTS
// ============================================================================

const PaperPlaneIcon = React.memo(() => (
  <svg className="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M22 2L11 13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </svg>
));
PaperPlaneIcon.displayName = "PaperPlaneIcon";

// ============================================================================
// REDUCER
// ============================================================================

const INITIAL_STATE = {
  formData: { name: '', email: '', message: '', website: '' },
  focused: { name: false, email: false, message: false },
  touched: { name: false, email: false, message: false },
  errors: { name: '', email: '', message: '' },
  isSubmitting: false,
  submitStatus: ''
};

const formReducer = (state, action) => {
  switch (action.type) {
    case 'UPDATE_FIELD':
      return {
        ...state,
        formData: {
          ...state.formData,
          [action.field]: action.value
        }
      };
    
    case 'FOCUS_FIELD':
      return {
        ...state,
        focused: {
          ...state.focused,
          [action.field]: true
        }
      };
    
    case 'BLUR_FIELD':
      return {
        ...state,
        touched: {
          ...state.touched,
          [action.field]: true
        },
        focused: {
          ...state.focused,
          [action.field]: !!state.formData[action.field]
        }
      };
    
    case 'SET_ERROR':
      return {
        ...state,
        errors: {
          ...state.errors,
          [action.field]: action.error
        }
      };
    
    case 'SET_ALL_TOUCHED':
      return {
        ...state,
        touched: { name: true, email: true, message: true }
      };
    
    case 'SET_SUBMITTING':
      return {
        ...state,
        isSubmitting: action.isSubmitting,
        submitStatus: action.status || state.submitStatus
      };
    
    case 'SET_SUBMIT_STATUS':
      return {
        ...state,
        submitStatus: action.status
      };
    
    case 'RESET':
      return INITIAL_STATE;
    
    default:
      return state;
  }
};


// ============================================================================
// VALIDATION
// ============================================================================

const validateField = (name, value) => {
  switch (name) {
    case 'name':
      if (!value.trim()) return 'Name is required';
      if (value.trim().length < 2) return 'Name must be at least 2 characters';
      return '';
    
    case 'email':
      if (!value.trim()) return 'Email is required';
      if (!EMAIL_REGEX.test(value)) return 'Please enter a valid email address';
      return '';
    
    case 'message':
      if (!value.trim()) return 'Message is required';
      if (value.trim().length < 10) return 'Message must be at least 10 characters';
      return '';
    
    default:
      return '';
  }
};

// ============================================================================
// API INTEGRATION
// ============================================================================

const sendMessage = async (data) => {
  // TODO: Replace with actual API endpoint
  return new Promise((resolve) => {
    setTimeout(() => {
      console.log('Form submitted:', data);
      resolve({ success: true });
    }, 1000);
  });
};

// ============================================================================
// MAIN COMPONENT
// ============================================================================

const Contact = () => {
  const [state, dispatch] = useReducer(formReducer, INITIAL_STATE);
  const statusRef = useRef(null);
  const lastSubmitTime = useRef(0);

  const handleChange = useCallback((e) => {
    const { name, value } = e.target;
    dispatch({ type: 'UPDATE_FIELD', field: name, value });
    
    // Real-time validation
    if (state.touched[name]) {
      const error = validateField(name, value);
      dispatch({ type: 'SET_ERROR', field: name, error });
    }
  }, [state.touched]);

  const handleFocus = useCallback((field) => {
    dispatch({ type: 'FOCUS_FIELD', field });
  }, []);

  const handleBlur = useCallback((field) => {
    dispatch({ type: 'BLUR_FIELD', field });
    
    // Validate on blur
    const error = validateField(field, state.formData[field]);
    dispatch({ type: 'SET_ERROR', field, error });
  }, [state.formData]);

  const handleSubmit = useCallback(async (e) => {
    e.preventDefault();
    
    // Rate limiting (3 seconds between submissions)
    const now = Date.now();
    if (now - lastSubmitTime.current < 3000) {
      dispatch({ type: 'SET_SUBMIT_STATUS', status: 'Please wait before submitting again.' });
      return;
    }
    
    // Honeypot check
    if (state.formData.website) {
      dispatch({ type: 'SET_SUBMIT_STATUS', status: 'Message sent successfully!' });
      setTimeout(() => dispatch({ type: 'RESET' }), 2000);
      return;
    }
    
    // Mark all fields as touched
    dispatch({ type: 'SET_ALL_TOUCHED' });
    
    // Validate all fields
    const errors = {
      name: validateField('name', state.formData.name),
      email: validateField('email', state.formData.email),
      message: validateField('message', state.formData.message)
    };
    
    // Set all errors
    Object.keys(errors).forEach(field => {
      dispatch({ type: 'SET_ERROR', field, error: errors[field] });
    });
    
    // Check if any errors exist
    if (Object.values(errors).some(error => error)) {
      dispatch({ type: 'SET_SUBMIT_STATUS', status: 'Please fix the errors before submitting.' });
      return;
    }
    
    dispatch({ type: 'SET_SUBMITTING', isSubmitting: true, status: 'Sending message...' });
    lastSubmitTime.current = now;
    
    try {
      await sendMessage({
        name: state.formData.name,
        email: state.formData.email,
        message: state.formData.message
      });
      
      dispatch({ type: 'SET_SUBMITTING', isSubmitting: false, status: 'Message sent successfully!' });
      
      // Focus on success message for screen readers
      setTimeout(() => {
        if (statusRef.current) {
          statusRef.current.focus();
        }
      }, 100);
      
      // Reset form after 3 seconds
      setTimeout(() => {
        dispatch({ type: 'RESET' });
      }, 3000);
    } catch (error) {
      dispatch({ 
        type: 'SET_SUBMITTING', 
        isSubmitting: false, 
        status: 'Failed to send message. Please try again.' 
      });
    }
  }, [state.formData]);

  return (
    <main className="contact-page" aria-labelledby="contact-title">
      <PageHeader 
        title="Get In Touch"
        subtitle="Letâ€™s Create Meaningful User Experiences"
      />
      
      <div className="contact-container">
        <div className="contact-grid">
          {/* Social Links - Stacked */}
          <nav className="social-links" aria-label="Social media links">
            {SOCIAL_LINKS.map((link) => (
              <a 
                key={link.className}
                href={link.href} 
                target="_blank" 
                rel="noopener noreferrer"
                className={`social-link ${link.className}`}
                aria-label={link.label}
                title={link.label}
              >
                <i className={link.icon} aria-hidden="true"></i>
                <span>{link.name}</span>
              </a>
            ))}
          </nav>

          {/* Contact Form */}
          <section className="contact-form-wrapper" aria-labelledby="form-heading">
            <h2 id="form-heading">Please fill out the form</h2>
            {formStatus && (
              <div 
                className="form-status" 
                role="status" 
                aria-live="polite"
                aria-atomic="true"
              >
                {formStatus}
              </div>
            )}
            <form 
              className="contact-form" 
              onSubmit={handleSubmit}
              aria-labelledby="form-heading"
              noValidate
            >
              <div className={`form-field ${focused.name || formData.name ? 'focused' : ''} ${touched.name ? 'touched' : ''}`}>
                <label htmlFor="name">Name</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  value={formData.name}
                  onChange={handleChange}
                  onFocus={() => handleFocus('name')}
                  onBlur={() => handleBlur('name')}
                  required
                  aria-required="true"
                  aria-describedby="name-help"
                  autoComplete="name"
                  disabled={isSubmitting}
                />
                <span id="name-help" className="visually-hidden">Enter your full name</span>
              </div>

              <div className={`form-field ${focused.email || formData.email ? 'focused' : ''} ${touched.email ? 'touched' : ''}`}>
                <label htmlFor="email">Email</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  value={formData.email}
                  onChange={handleChange}
                  onFocus={() => handleFocus('email')}
                  onBlur={() => handleBlur('email')}
                  required
                  aria-required="true"
                  aria-describedby="email-help"
                  autoComplete="email"
                  disabled={isSubmitting}
                />
                <span id="email-help" className="visually-hidden">Enter a valid email address</span>
              </div>

              <div className={`form-field ${focused.message || formData.message ? 'focused' : ''} ${touched.message ? 'touched' : ''}`}>
                <label htmlFor="message">Message</label>
                <textarea
                  id="message"
                  name="message"
                  rows="5"
                  value={formData.message}
                  onChange={handleChange}
                  onFocus={() => handleFocus('message')}
                  onBlur={() => handleBlur('message')}
                  required
                  aria-required="true"
                  aria-describedby="message-help"
                  disabled={isSubmitting}
                ></textarea>
                <span id="message-help" className="visually-hidden">Enter your message, minimum 10 characters</span>
              </div>

              <button 
                type="submit" 
                className="submit-btn"
                aria-label="Send message to Riad Kilani"
                disabled={isSubmitting}
                aria-busy={isSubmitting}
              >
                <span>{isSubmitting ? 'Sending...' : 'Send Message'}</span>
                <svg className="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M22 2L11 13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
              </button>
            </form>
          </section>
        </div>
      </div>
    </main>
  );
}

export default Contact;
